services:
  # ── API: приём файлов, постановка задач в очередь ─────────────────────────
  api:
    build:
      context: .
      dockerfile: Dockerfile
    command: uvicorn api.main:app --host 0.0.0.0 --port 8000
    user: "1000:100"
    ports:
      - "8000:8000"
    depends_on:
      - redis
    environment:
      REDIS_HOST: redis
      UPLOAD_DIR: /app/uploads
    volumes:
      - uploads:/app/uploads

  # ── Worker: конвертация (ffmpeg) + шумоподавление + вызов ASR ─────────────
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    command: celery -A api.tasks.celery_app worker --loglevel=info --concurrency=4
    user: "1000:100"
    depends_on:
      - redis
      - asr
    environment:
      REDIS_HOST: redis
      ASR_SERVICE_URL: http://asr:8001
      UPLOAD_DIR: /app/uploads
    volumes:
      - uploads:/app/uploads

  # ── ASR: GPU-контейнер с Qwen3-ASR ────────────────────────────────────────
  asr:
    build:
      context: .
      dockerfile: Dockerfile.asr-gpu
    user: "1000:100"
    ports:
      - "8001:8001"
    environment:
      ASR_MODEL_ID: Qwen/Qwen3-ASR-1.7B
      ASR_LANGUAGE: Russian
      ASR_CHUNK_S: "30"
      ASR_MAX_TOKENS: "256"
    volumes:
      - hf-cache:/root/.cache/huggingface
    devices:
      - nvidia.com/gpu=all

  # ── Demo: Gradio-стенд + callback-приёмник ────────────────────────────────
  demo:
    build:
      context: .
      dockerfile: Dockerfile.demo
    user: "1000:100"
    ports:
      - "7860:7860"
    depends_on:
      - api
      - asr
    environment:
      API_URL: http://api:8000
      ASR_URL: http://asr:8001
      DEMO_URL: http://demo:7860

  # ── Redis ──────────────────────────────────────────────────────────────────
  redis:
    image: redis:8.0-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

volumes:
  uploads:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/resursator/dev/agat-test/examples/uploads
  redis-data:
  hf-cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/resursator/.cache/huggingface
