services:
  # ── API: приём файлов, постановка задач в очередь ─────────────────────────
  api:
    image: api
    pull_policy: never
    build:
      context: .
      dockerfile: Dockerfile
    command: uvicorn api.main:app --host 0.0.0.0 --port 8000
    user: "1000:100"
    ports:
      - "8000:8000"
    depends_on:
      - redis
    environment:
      TZ: Europe/Moscow
      REDIS_HOST: redis
      UPLOAD_DIR: /app/uploads
    volumes:
      - uploads:/app/uploads

  # ── Worker: конвертация (ffmpeg) + шумоподавление + вызов ASR ─────────────
  worker:
    image: worker
    pull_policy: never
    build:
      context: .
      dockerfile: Dockerfile
    command: celery -A api.tasks.celery_app worker --loglevel=info --concurrency=4
    user: "1000:100"
    depends_on:
      - redis
      - asr
    environment:
      TZ: Europe/Moscow
      ASR_HEALTH_TIMEOUT: "900" # максимальное ожидание, сек (по умолчанию 15 мин)
      ASR_HEALTH_INTERVAL: "10" # пауза между попытками, сек
      REDIS_HOST: redis
      ASR_SERVICE_URL: http://asr:8001
      UPLOAD_DIR: /app/uploads
    volumes:
      - uploads:/app/uploads

  # ── ASR: CPU-контейнер с faster-whisper ───────────────────────────────────
  asr:
    image: ru-asr:cpu
    pull_policy: never
    build:
      context: .
      dockerfile: Dockerfile.asr-cpu
    user: "1000:100"
    ports:
      - "8001:8001"
    environment:
      TZ: Europe/Moscow
      ASR_MODEL_SIZE: medium # turbo/tiny/base/small/medium/large-v3
      ASR_LANGUAGE: ru
      ASR_CPU_THREADS: "4"
    volumes:
      - hf-cache:/home/appuser/.cache/huggingface

  # ── Demo: Gradio-стенд + callback-приёмник ────────────────────────────────
  demo:
    image: demo
    pull_policy: never
    build:
      context: .
      dockerfile: Dockerfile.demo
    user: "1000:100"
    ports:
      - "7860:7860"
    depends_on:
      - api
      - asr
    environment:
      TZ: Europe/Moscow
      API_URL: http://api:8000
      ASR_URL: http://asr:8001
      DEMO_URL: http://demo:7860

  # ── Redis ──────────────────────────────────────────────────────────────────
  redis:
    image: redis:8.0-alpine
    ports:
      - "6379:6379"
    environment:
      TZ: Europe/Moscow
    volumes:
      - redis-data:/data

volumes:
  uploads:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/resursator/dev/agat-test/examples/uploads
  redis-data:
  hf-cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/resursator/.cache/huggingface
